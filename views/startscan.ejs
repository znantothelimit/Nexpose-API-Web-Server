<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” ìŠ¤ìº” ì‹¤í–‰</title>
  <link rel="stylesheet" href="/startscan.css">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h2>ğŸ” ìŠ¤ìº” ì‹¤í–‰</h2>

  <form action="/startscan" method="POST">
    <label>
      ğŸ“„ ì‚¬ì´íŠ¸ ì„ íƒ:
      <select name="siteId" id="siteSelector" required onchange="onSiteChange()">
        <option value="">-- ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
        <% sites.forEach(site => { %>
          <option value="<%= site.id %>"><%= site.name %> (ID: <%= site.id %>)</option>
        <% }); %>
      </select>
    </label>

    <label>
      ğŸŒ ëŒ€ìƒ í˜¸ìŠ¤íŠ¸(IP):
      <input type="text" name="host" id="hostInput" placeholder="ì˜ˆ: 192.168.0.100 ë˜ëŠ” ë³µìˆ˜ ì…ë ¥ ì‹œ ,ë¡œ êµ¬ë¶„" required />
    </label>

    <label>
      âš™ï¸ ì—”ì§„ ID:
      <select name="engineId" id="engineSelector" required>
        <% engines.forEach(engine => { %>
          <option value="<%= engine.id %>"><%= engine.name %> (ID: <%= engine.id %>)</option>
        <% }); %>
      </select>
    </label>

    <label>
      ğŸ“ ìŠ¤ìº” í…œí”Œë¦¿:
      <select name="templateId" id="templateSelector" required>
        <% templates.forEach(template => { %>
          <option value="<%= template.id %>" <%= template.id === 'full-audit' ? 'selected' : '' %>>
            <%= template.name %> (<%= template.id %>)
          </option>
        <% }); %>
      </select>
    </label>

    <button type="submit">ìŠ¤ìº” ì‹œì‘</button>
  </form>

  <a href="/">â¬… í™ˆìœ¼ë¡œ</a>

  <script>
    async function onSiteChange() {
      const siteId = document.getElementById('siteSelector').value;
      if (!siteId) return;
  
      await fetchSiteAssets(siteId);
      await fetchSiteEngine(siteId);
      await fetchSiteTemplate(siteId); // âœ… ì¶”ê°€
    }
  
    async function fetchSiteAssets(siteId) {
      const hostInput = document.getElementById('hostInput');
      try {
        const res = await fetch(`/startscan/site-assets/${siteId}`);
        const data = await res.json();
        if (data.success && data.addresses.length > 0) {
          hostInput.value = data.addresses.join(', ');
        } else {
          hostInput.value = '';
          alert('ì´ ì‚¬ì´íŠ¸ì— í¬í•¨ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìì‚° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
        alert('ìì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        hostInput.value = '';
      }
    }
  
    async function fetchSiteEngine(siteId) {
      const engineSelector = document.getElementById('engineSelector');
      try {
        const res = await fetch(`/startscan/site-engine/${siteId}`);
        const data = await res.json();
        if (data.success && data.engineId) {
          engineSelector.value = data.engineId;
        }
      } catch (err) {
        console.error('ì—”ì§„ ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
      }
    }
  
    // âœ… ìƒˆë¡œ ì¶”ê°€: ì‚¬ì´íŠ¸ì— í• ë‹¹ëœ í…œí”Œë¦¿ ID ê°€ì ¸ì™€ ë“œë¡­ë‹¤ìš´ì— ë°˜ì˜
    async function fetchSiteTemplate(siteId) {
      const templateSelector = document.getElementById('templateSelector');
      try {
        const res = await fetch(`/startscan/site-template/${siteId}`);
        const data = await res.json();
        if (data.success && data.templateId) {
          templateSelector.value = data.templateId;
        }
      } catch (err) {
        console.error('í…œí”Œë¦¿ ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
      }
    }
  </script>
</body>
</html>
