<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“„ Nexpose ë³´ê³ ì„œ ì„¤ì •</title>
  <link rel="stylesheet" href="/reportconfig.css" />
  <link rel="stylesheet" href="/style.css" />
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const siteSelect = document.getElementById('siteSelect');
      const scanSelect = document.getElementById('scanSelect');
      const scanLoading = document.getElementById('scanLoading');
      const formatSelect = document.getElementById('formatSelect');
      const queryField = document.getElementById('queryField');

      // ì‚¬ì´íŠ¸ ì„ íƒ ì‹œ ìŠ¤ìº” ëª©ë¡ ë¡œë“œ
      siteSelect.addEventListener('change', async () => {
        const siteId = siteSelect.value;
        if (!siteId) return;

        scanLoading.style.display = 'inline';
        scanSelect.innerHTML = '<option value="">ìŠ¤ìº” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';
        scanSelect.disabled = true;

        try {
          const res = await fetch(`/reportconfig/scans/${siteId}`);
          const scans = await res.json();

          scanSelect.innerHTML = '<option value="">ìŠ¤ìº” ì„ íƒ</option>';
          scans.forEach(scan => {
            const option = document.createElement('option');
            const time = new Date(scan.startTime).toLocaleString();
            option.value = scan.id;
            option.textContent = `${scan.scanName} (${scan.status}, ${time})`;
            scanSelect.appendChild(option);
          });

          scanSelect.disabled = false;
        } catch (err) {
          scanSelect.innerHTML = '<option value="">âš  ìŠ¤ìº” ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</option>';
        } finally {
          scanLoading.style.display = 'none';
        }
      });

      // ì¶œë ¥ í¬ë§·ì— ë”°ë¼ SQL ì…ë ¥ í•„ë“œ í‘œì‹œ ì—¬ë¶€ ê²°ì •
      formatSelect.addEventListener('change', () => {
        if (formatSelect.value === 'sql-query') {
          queryField.style.display = 'block';
        } else {
          queryField.style.display = 'none';
        }
      });
    });
  </script>
</head>
<body>
  <h1>ğŸ“„ Nexpose ë³´ê³ ì„œ ì„¤ì •</h1>

  <form action="/reportconfig" method="POST">
    <label>
      ğŸ· ì‚¬ì´íŠ¸:
      <select id="siteSelect" required>
        <option value="">ì‚¬ì´íŠ¸ ì„ íƒ</option>
        <% sites.forEach(site => { %>
          <option value="<%= site.id %>"><%= site.name %></option>
        <% }) %>
      </select>
    </label>

    <label>
      ğŸ§ª ìŠ¤ìº”:
      <select name="scanId" id="scanSelect" required disabled>
        <option value="">ë¨¼ì € ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
      <span id="scanLoading" style="display:none">ğŸ”„</span>
    </label>

    <label>
      ğŸ“˜ ë³´ê³ ì„œ ì´ë¦„:
      <input type="text" name="name" placeholder="ì˜ˆ: ì·¨ì•½ì  ë¦¬í¬íŠ¸" />
    </label>

    <label>
      ğŸŒ ì–¸ì–´:
      <input type="text" name="language" placeholder="ì˜ˆ: en-US ë˜ëŠ” ko-KR" />
    </label>

    <label>
      ğŸ§¾ ë³´ê³ ì„œ í…œí”Œë¦¿:
      <select name="template" required>
        <option value="">í…œí”Œë¦¿ ì„ íƒ</option>
        <% templates.forEach(tpl => { %>
          <option value="<%= tpl.id %>"><%= tpl.name %></option>
        <% }) %>
      </select>
    </label>

    <label>
      ğŸ“‚ ì¶œë ¥ í¬ë§·:
      <select name="format" id="formatSelect" required>
        <option value="">ì¶œë ¥ í˜•ì‹ ì„ íƒ</option>
        <% formats.forEach(fmt => { %>
          <option value="<%= fmt.format %>"><%= fmt.format.toUpperCase() %></option>
        <% }) %>
      </select>
    </label>    

    <div id="queryField" style="display:none">
      <label>
        ğŸ§  SQL ì¿¼ë¦¬ (Reporting Data Modelìš©):
        <textarea name="query" rows="6" placeholder="ì˜ˆ: SELECT * FROM dim_asset"></textarea>
      </label>
    </div>

    <button type="submit">ğŸ“¤ ë³´ê³ ì„œ ìƒì„±</button>
  </form>

  <a href="/">â¬… í™ˆìœ¼ë¡œ</a>
</body>
</html>
